<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KNS Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes neonGlow {
      0% { text-shadow: 0 0 5px #00ff88, 0 0 10px #00ff88, 0 0 20px #00ff88; }
      100% { text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88, 0 0 30px #00ff88; }
    }
    @keyframes starTwinkle {
      0% { opacity: 0.4; }
      50% { opacity: 0.8; }
      100% { opacity: 0.4; }
    }
    .neon-text { animation: neonGlow 1.5s alternate infinite; }
    .kns-dark { background-color: #0a0a1a; }
    .cosmos-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, #1a1a40 0%, #0a0a1a 100%);
      z-index: -1;
      overflow: hidden;
    }
    .cosmos-bg::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: url('https://cdn.pixabay.com/photo/2017/08/30/01/05/milky-way-2695569_1280.jpg') no-repeat center/cover;
      opacity: 0.6;
      animation: starTwinkle 8s infinite ease-in-out;
    }
    .cosmos-bg::after {
      content: '';
      position: absolute;
      width: 2px;
      height: 2px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 10px #fff, 0 0 20px #00ff88;
      animation: starTwinkle 5s infinite ease-in-out;
      top: 20%;
      left: 80%;
    }
    .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .chat-container { transition: all 0.3s ease; }
    .chat-container:hover { transform: scale(1.01); }
    input:focus { outline: none; box-shadow: 0 0 10px #00ff88; }
  </style>
</head>
<body class="kns-dark min-h-screen text-white font-sans relative">
  <div class="cosmos-bg"></div>
  <div id="root">
    <p>Loading KNS Chat... If this persists, check the console for errors.</p>
  </div>
  <script>
    const { createElement, useState, useEffect } = React;
    const { render } = ReactDOM;

    // Pure functions
    const createMessage = (text, user, timestamp) => ({ id: Date.now(), text, user, timestamp });
    const addMessage = (messages, newMessage) => [...messages, newMessage];

    // Mock tokenization
    const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imtuc3VzZXIiLCJpYXQiOjE3MzA0OTk5OTl9.dummy';
    const mockVerifyToken = (token) => token === mockToken ? { username: 'knsuser' } : null;

    // Mock API with reply simulation
    const mockApi = {
      sendMessage: (message, token) => {
        console.log('Sending message:', message);
        if (!mockVerifyToken(token)) {
          console.error('Invalid token');
          throw new Error('Invalid token');
        }
        // Simulate server response with a bot reply
        const botReply = createMessage(
          `KNS Bot received: "${message.text}"`,
          'KNS Bot',
          new Date(Date.now() + 1000).toISOString()
        );
        return Promise.resolve({ userMessage: { ...message, id: Date.now() }, botReply });
      },
      fetchMessages: (token) => {
        console.log('Fetching initial messages');
        if (!mockVerifyToken(token)) {
          console.error('Invalid token');
          throw new Error('Invalid token');
        }
        return Promise.resolve([
          createMessage('Welcome to KNS Chat! ðŸŒŒ', 'KNS Bot', new Date().toISOString()),
          createMessage('Type a message to get a response from the nexus.', 'KNS Bot', new Date().toISOString())
        ]);
      }
    };

    // ViewModel
    const useChatViewModel = () => {
      const [state, setState] = useState({
        messages: [],
        input: '',
        user: 'knsuser',
        token: mockToken
      });

      const updateState = (updates) => {
        console.log('Updating state:', updates);
        setState(prev => ({ ...prev, ...updates }));
      };

      const fetchMessages = async () => {
        try {
          const messages = await mockApi.fetchMessages(state.token);
          updateState({ messages });
        } catch (error) {
          console.error('Fetch messages failed:', error);
        }
      };

      const sendMessage = async () => {
        if (!state.input.trim()) {
          console.log('Empty input, not sending');
          return;
        }
        const newMessage = createMessage(state.input, state.user, new Date().toISOString());
        try {
          const { userMessage, botReply } = await mockApi.sendMessage(newMessage, state.token);
          updateState({
            messages: addMessage(addMessage(state.messages, userMessage), botReply),
            input: ''
          });
          console.log('Message sent and bot replied:', userMessage, botReply);
        } catch (error) {
          console.error('Send message failed:', error);
        }
      };

      useEffect(() => {
        fetchMessages();
      }, []);

      return { state, sendMessage, updateState };
    };

    // Message component
    const Message = ({ message }) => createElement(
      'div',
      { className: 'p-4 m-2 glass rounded-lg transition-transform hover:scale-105' },
      createElement('p', { className: 'text-sm text-gray-400' }, `${message.user} â€¢ ${new Date(message.timestamp).toLocaleTimeString()}`),
      createElement('p', { className: 'text-lg text-white' }, message.text)
    );

    // ChatApp component
    const ChatApp = () => {
      const { state, sendMessage, updateState } = useChatViewModel();

      const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
          console.log('Enter pressed, sending message');
          sendMessage();
        }
      };

      return createElement(
        'div',
        { className: 'max-w-4xl mx-auto p-4 chat-container relative z-10' },
        createElement('h1', { className: 'text-4xl neon-text mb-6' }, 'KNS Chat'),
        createElement(
          'div',
          { className: 'h-[70vh] overflow-y-auto mb-4 p-4 glass rounded-lg' },
          state.messages.map(message => createElement(Message, { key: message.id, message }))
        ),
        createElement(
          'div',
          { className: 'flex gap-2' },
          createElement('input', {
            type: 'text',
            value: state.input,
            onChange: e => updateState({ input: e.target.value }),
            onKeyPress: handleKeyPress,
            placeholder: 'Type a message...',
            className: 'flex-1 p-3 glass text-white rounded-lg bg-transparent border-gray-600 text-lg'
          }),
          createElement('button', {
            onClick: () => {
              console.log('Send button clicked');
              sendMessage();
            },
            className: 'p-3 bg-gradient-to-r from-green-500 to-cyan-500 rounded-lg neon-text hover:from-green-600 hover:to-cyan-600 transition-all'
          }, 'Send')
        )
      );
    };

    // Render with error handling
    try {
      render(createElement(ChatApp), document.getElementById('root'));
    } catch (error) {
      console.error('Failed to render KNS Chat:', error);
    }
  </script>
</body>
</html>