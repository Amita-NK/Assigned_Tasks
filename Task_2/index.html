<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNS Video Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
    <style>
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}
        html{line-height:1.5;-webkit-text-size-adjust:100%;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}
        body{margin:0;line-height:inherit;background-image:url('https://images.pexels.com/photos/1154738/pexels-photo-1154738.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');background-size:cover;background-attachment:fixed;background-position:center}
        .flex{display:flex}
        .min-h-screen{min-height:100vh}
        .flex-1{flex:1}
        .flex-col{flex-direction:column}
        .items-center{align-items:center}
        .justify-center{justify-content:center}
        .gap-1{gap:.25rem}
        .gap-2{gap:.5rem}
        .gap-4{gap:1rem}
        .w-2{width:.5rem}
        .h-2{height:.5rem}
        .w-8{width:2rem}
        .h-8{height:2rem}
        .w-80{width:20rem}
        .w-1\/2{width:50%}
        .max-w-\[80\%\]{max-width:80%}
        .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .rounded-full{border-radius:9999px}
        .rounded-lg{border-radius:.5rem}
        .border{border-width:1px}
        .border-t{border-top-width:1px}
        .border-b{border-bottom-width:1px}
        .border-gray-200{border-color:#e5e7eb}
        .bg-black{background-color:#000}
        .bg-gray-100{background-color:#f3f4f6}
        .bg-blue-100{background-color:#dbeafe}
        .bg-gray-100{background-color:#8b9dd8}
        .bg-blue-500{background-color:#3b82f6}
        .bg-green-500{background-color:#22c55e}
        .bg-red-500{background-color:#ef4444}
        .bg-white{background-color:#fff}
        .bg-blue-600{background-color:#2563eb}
        .bg-opacity-80{background-opacity:0.8}
        .p-1{padding:.25rem}
        .p-2{padding:.5rem}
        .p-4{padding:1rem}
        .text-sm{font-size:.875rem;line-height:1.25rem}
        .text-lg{font-size:1.125rem;line-height:1.75rem}
        .text-2xl{font-size:1.5rem;line-height:2rem}
        .font-semibold{font-weight:600}
        .font-bold{font-weight:700}
        .text-white{color:#fff}
        .text-blue-600{color:#2563eb}
        .text-gray-600{color:#4b5563}
        .shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1)}
        .shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1)}
        .hover\:bg-blue-600:hover{background-color:#2563eb}
        .hover\:opacity-80:hover{opacity:.8}
        .hover\:scale-105:hover{transform:scale(1.05)}
        .overflow-y-auto{overflow-y:auto}
        .ml-auto{margin-left:auto}
        .transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}
        .animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const VideoChat = () => {
            const [peerId, setPeerId] = useState('');
            const [remotePeerId, setRemotePeerId] = useState('');
            const [chatMessages, setChatMessages] = useState([]);
            const [message, setMessage] = useState('');
            const [participants, setParticipants] = useState([]);
            const [isScreenSharing, setIsScreenSharing] = useState(false);
            const [isVideoOn, setIsVideoOn] = useState(true);
            const [isAudioOn, setIsAudioOn] = useState(true);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const localVideoRef = useRef(null);
            const remoteVideoRef = useRef(null);
            const peerInstance = useRef(null);
            const dataConnection = useRef(null);
            const chatInputRef = useRef(null);
            const localStream = useRef(null);

            useEffect(() => {
                const peer = new Peer({
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    pingInterval: 5000,
                });

                peer.on('open', (id) => {
                    setPeerId(id);
                    setParticipants([{ id, status: 'online' }]);
                });

                peer.on('connection', (conn) => {
                    dataConnection.current = conn;
                    setParticipants(prev => [...prev, { id: conn.peer, status: 'online' }]);

                    conn.on('data', (data) => {
                        if (data.type === 'chat') {
                            setChatMessages(prev => [...prev, { 
                                sender: conn.peer, 
                                text: data.text,
                                timestamp: new Date().toLocaleTimeString()
                            }]);
                        }
                    });

                    conn.on('close', () => {
                        setParticipants(prev => prev.filter(p => p.id !== conn.peer));
                    });
                });

                peer.on('call', (call) => {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                        .then((stream) => {
                            localStream.current = stream;
                            localVideoRef.current.srcObject = stream;
                            localVideoRef.current.play();
                            call.answer(stream);
                            call.on('stream', (remoteStream) => {
                                remoteVideoRef.current.srcObject = remoteStream;
                                remoteVideoRef.current.play();
                            });
                        })
                        .catch((err) => console.error('Failed to get local stream', err));
                });

                peerInstance.current = peer;

                return () => {
                    peer.destroy();
                };
            }, []);

            const toggleVideo = () => {
                if (localStream.current) {
                    localStream.current.getVideoTracks()[0].enabled = !isVideoOn;
                    setIsVideoOn(!isVideoOn);
                }
            };

            const toggleAudio = () => {
                if (localStream.current) {
                    localStream.current.getAudioTracks()[0].enabled = !isAudioOn;
                    setIsAudioOn(!isAudioOn);
                }
            };

            const toggleFullscreen = () => {
                if (!isFullscreen) {
                    document.documentElement.requestFullscreen();
                    setIsFullscreen(true);
                } else {
                    document.exitFullscreen();
                    setIsFullscreen(false);
                }
            };

            const callPeer = () => {
                if (!remotePeerId) return;

                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then((stream) => {
                        localStream.current = stream;
                        localVideoRef.current.srcObject = stream;
                        localVideoRef.current.play();

                        const call = peerInstance.current.call(remotePeerId, stream);
                        call.on('stream', (remoteStream) => {
                            remoteVideoRef.current.srcObject = remoteStream;
                            remoteVideoRef.current.play();
                        });

                        const conn = peerInstance.current.connect(remotePeerId);
                        dataConnection.current = conn;
                        setParticipants(prev => [...prev, { id: remotePeerId, status: 'online' }]);

                        conn.on('data', (data) => {
                            if (data.type === 'chat') {
                                setChatMessages(prev => [...prev, { 
                                    sender: remotePeerId, 
                                    text: data.text,
                                    timestamp: new Date().toLocaleTimeString()
                                }]);
                            }
                        });

                        conn.on('close', () => {
                            setParticipants(prev => prev.filter(p => p.id !== remotePeerId));
                        });
                    })
                    .catch((err) => console.error('Failed to get local stream', err));
            };

            const startScreenShare = async () => {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    localStream.current = stream;
                    localVideoRef.current.srcObject = stream;
                    localVideoRef.current.play();
                    setIsScreenSharing(true);

                    if (dataConnection.current) {
                        const call = peerInstance.current.call(remotePeerId, stream);
                        call.on('stream', (remoteStream) => {
                            remoteVideoRef.current.srcObject = remoteStream;
                            remoteVideoRef.current.play();
                        });
                    }

                    stream.getVideoTracks()[0].onended = () => {
                        setIsScreenSharing(false);
                        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                            .then((camStream) => {
                                localStream.current = camStream;
                                localVideoRef.current.srcObject = camStream;
                                localVideoRef.current.play();
                            });
                    };
                } catch (err) {
                    console.error('Failed to share screen', err);
                }
            };

            const sendMessage = () => {
                if (message && dataConnection.current) {
                    dataConnection.current.send({ type: 'chat', text: message });
                    setChatMessages(prev => [...prev, { 
                        sender: peerId, 
                        text: message,
                        timestamp: new Date().toLocaleTimeString()
                    }]);
                    setMessage('');
                    chatInputRef.current.focus();
                }
            };

            return (
                <div className="min-h-screen flex flex-col bg-opacity-80">
                    <header className="bg-blue-600 text-white p-4 shadow-md transition-all flex items-center gap-4">
                        <svg className="w-8 h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="white" strokeWidth="2"/>
                            <path d="M8 12L10 14L16 8" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                        <div>
                            <h1 className="text-2xl font-bold">KNS Video Chat</h1>
                            <p className="text-sm">Connect Seamlessly with KNS</p>
                        </div>
                        <p className="text-sm animate-pulse ml-auto">Your ID: {peerId || 'Connecting...'}</p>
                    </header>
                    <main className="flex flex-1 p-4 gap-4">
                        <div className="flex-1 flex flex-col gap-4">
                            <div className="flex gap-4">
                                <video 
                                    ref={localVideoRef} 
                                    autoPlay 
                                    muted 
                                    className="w-1/2 rounded-lg shadow-lg bg-black hover:scale-105 transition-all" 
                                />
                                <video 
                                    ref={remoteVideoRef} 
                                    autoPlay 
                                    className="w-1/2 rounded-lg shadow-lg bg-black hover:scale-105 transition-all" 
                                />
                            </div>
                            <div className="flex gap-2 flex-wrap">
                                <input
                                    type="text"
                                    value={remotePeerId}
                                    onChange={(e) => setRemotePeerId(e.target.value)}
                                    placeholder="Enter remote peer ID"
                                    className="flex-1 p-2 rounded-lg border transition-all"
                                />
                                <button
                                    onClick={callPeer}
                                    className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-all"
                                >
                                    Connect
                                </button>
                                <button
                                    onClick={startScreenShare}
                                    className={`p-2 rounded-lg ${isScreenSharing ? 'bg-red-500' : 'bg-green-500'} text-white hover:opacity-80 transition-all`}
                                >
                                    {isScreenSharing ? 'Stop Sharing' : 'Share Screen'}
                                </button>
                                <button
                                    onClick={toggleVideo}
                                    className={`p-2 rounded-lg ${isVideoOn ? 'bg-gray-500' : 'bg-blue-500'} text-white hover:opacity-80 transition-all`}
                                >
                                    {isVideoOn ? 'Video Off' : 'Video On'}
                                </button>
                                <button
                                    onClick={toggleAudio}
                                    className={`p-2 rounded-lg ${isAudioOn ? 'bg-gray-500' : 'bg-blue-500'} text-white hover:opacity-80 transition-all`}
                                >
                                    {isAudioOn ? 'Mute' : 'Unmute'}
                                </button>
                                <button
                                    onClick={toggleFullscreen}
                                    className="bg-gray-500 text-white p-2 rounded-lg hover:opacity-80 transition-all"
                                >
                                    {isFullscreen ? 'Exit Fullscreen' : 'Fullscreen'}
                                </button>
                            </div>
                        </div>
                        <div className="w-80 flex flex-col bg-white rounded-lg shadow-lg bg-opacity-80">
                            <div className="p-4 border-b">
                                <h2 className="text-lg font-semibold">Chat</h2>
                            </div>
                            <div className="flex-1 p-4 overflow-y-auto">
                                {chatMessages.map((msg, index) => (
                                    <div
                                        key={index}
                                        className={`mb-2 p-2 rounded-lg transition-all ${
                                            msg.sender === peerId ? 'bg-blue-100 ml-auto' : 'bg-gray-100'
                                        } max-w-[80%]`}
                                    >
                                        <p className="text-sm font-semibold">{msg.sender === peerId ? 'You' : 'Other'} ({msg.timestamp})</p>
                                        <p className="text-sm">{msg.text}</p>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 border-t">
                                <div className="flex gap-2">
                                    <input
                                        ref={chatInputRef}
                                        type="text"
                                        value={message}
                                        onChange={(e) => setMessage(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                        placeholder="Type a message..."
                                        className="flex-1 p-2 rounded-lg border transition-all"
                                    />
                                    <button
                                        onClick={sendMessage}
                                        className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-all"
                                    >
                                        Send
                                    </button>
                                </div>
                            </div>
                            <div className="p-4 border-t">
                                <h2 className="text-lg font-semibold">Participants</h2>
                                <ul className="mt-2">
                                    {participants.map((p) => (
                                        <li key={p.id} className="flex items-center gap-2 p-1">
                                            <span className={`w-2 h-2 rounded-full ${p.status === 'online' ? 'bg-green-500' : 'bg-red-500'} animate-pulse`} />
                                            <span className="text-sm truncate">{p.id}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        ReactDOM.render(<VideoChat />, document.getElementById('root'));
    </script>
</body>
</html>